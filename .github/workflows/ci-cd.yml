name: ğŸš€ CI + SAST (Semgrep)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1 : Tests unitaires et intÃ©gration
  test:
    name: ğŸ§ª Tests API
    runs-on: self-hosted   # âš¡ Remplacez par self-hosted si vous utilisez votre VM
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci

      - name: ğŸ” Linter ESLint
        run: npm run lint
        continue-on-error: true

      - name: ğŸ§ª ExÃ©cuter les tests unitaires
        run: npm test

      - name: ğŸ“Š GÃ©nÃ©rer le rapport de couverture
        run: npm run coverage
        continue-on-error: true

      - name: ğŸ“¤ Upload rapport de couverture
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # Job 2 : SAST avec Semgrep
  sast:
    name: ğŸ”’ SAST - Semgrep
    runs-on: ubuntu-latest   # âš¡ Remplacez par self-hosted si besoin
    needs: test
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      # Ã‰tape 1 : Scan avec l'action officielle (affichage immÃ©diat)
      - name: ğŸ” Scan Semgrep (action)
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true
        with:
          config: .semgrep.yml
          # Pas de json/output ici ; l'action affiche les rÃ©sultats dans la console

      # Ã‰tape 2 : Installation de Semgrep (pour gÃ©nÃ©rer le rapport JSON)
      - name: ğŸ“¦ Installer Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      # Ã‰tape 3 : GÃ©nÃ©rer le rapport JSON complet
      - name: ğŸ“Š GÃ©nÃ©rer le rapport JSON
        run: |
          semgrep --config .semgrep.yml --json --output semgrep-results.json
        continue-on-error: true

      # Ã‰tape 4 : Analyser le rapport (compter les vulnÃ©rabilitÃ©s)
      - name: ğŸ“ˆ Analyser les rÃ©sultats
        run: |
          echo "=== RÃ‰SULTATS SAST ==="
          if [ -f semgrep-results.json ]; then
            COUNT=$(jq '.results | length' semgrep-results.json)
            echo "ğŸ” $COUNT vulnÃ©rabilitÃ©(s) trouvÃ©e(s)"
            jq '.results[] | "âš ï¸  [\(.extra.severity)] \(.check_id) - \(.path):\(.start.line)"' semgrep-results.json
          else
            echo "âœ… Aucun rÃ©sultat (fichier JSON non gÃ©nÃ©rÃ©)"
          fi

      # Ã‰tape 5 : Upload du rapport JSON (optionnel mais recommandÃ©)
      - name: ğŸ“¤ Upload des rÃ©sultats Semgrep
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

      # Ã‰tape 6 : (Optionnel) Importer dans DefectDojo si runner auto-hÃ©bergÃ©
      # - name: ğŸ“¤ Importer dans DefectDojo
      #   if: runner.name == 'self-hosted'  # ou utilisez toujours si l'URL est accessible
      #   env:
      #     DD_URL: http://localhost:8080   # pour self-hosted
      #     DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      #   run: |
      #     curl -X POST "$DD_URL/api/v2/import-scan/" \
      #       -H "Authorization: Token $DD_API_KEY" \
      #       -F "engagement=1" \
      #       -F "scan_type=Semgrep JSON Report" \
      #       -F "file=@semgrep-results.json" \
      #       -F "close_old_findings=true"

  # Job 3 : Conclusion (optionnel)
  conclusion:
    name: ğŸ‰ Pipeline terminÃ©
    runs-on: ubuntu-latest
    needs: [test, sast]
    if: always()
    steps:
      - name: âœ… Finalisation
        run: echo "âœ… CI + SAST exÃ©cutÃ© avec succÃ¨s !"