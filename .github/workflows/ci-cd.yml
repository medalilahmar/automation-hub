name: üîí DevSecOps Pipeline - Zero VM Config

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sast:
    name: üîç SAST + DefectDojo
    runs-on: self-hosted
    
    steps:
    - name: üì• R√©cup√©rer le code
      uses: actions/checkout@v4

    # ---------- SEMGREP (via action officielle) ----------
    - name: üîç SAST avec Semgrep
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: .semgrep.yml

    # ---------- INSTALLATION JQ ULTRA-ROBUSTE ----------
    - name: üì¶ Installer jq (sans blocage)
      run: |
        if command -v jq &> /dev/null; then
          echo "‚úÖ jq d√©j√† install√©: $(jq --version)"
          exit 0
        fi
        
        echo "üîß Nettoyage des processus apt bloqu√©s..."
        sudo killall apt apt-get dpkg 2>/dev/null || true
        sudo rm -f /var/lib/dpkg/lock-frontend
        sudo rm -f /var/lib/dpkg/lock
        sudo rm -f /var/cache/apt/archives/lock
        sudo rm -f /var/lib/apt/lists/lock
        sudo dpkg --configure -a
        
        echo "üì¶ Tentative d'installation via apt..."
        if sudo apt update -qq && sudo apt install -y -qq jq; then
          echo "‚úÖ jq install√© avec apt: $(jq --version)"
        else
          echo "‚ö†Ô∏è  √âchec apt, installation directe du binaire..."
          wget -q -O jq https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux64
          chmod +x jq
          sudo mv jq /usr/local/bin/
          echo "‚úÖ jq install√© via binaire: $(jq --version)"
        fi

    # ---------- G√âN√âRATION RAPPORT JSON ----------
    - name: üìä G√©n√©rer rapport JSON
      run: semgrep --config .semgrep.yml --json --output semgrep-results.json || true

    # ---------- UPLOAD ARTEFACTS ----------
    - name: üì§ Upload rapport Semgrep
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-results
        path: semgrep-results.json

    # ---------- IMPORT DEFECTDOJO ----------
    - name: üì§ Importer dans DefectDojo
      env:
        DD_URL: http://localhost:8080
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
        PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
      run: |
        echo "üîç V√©rification du fichier JSON..."
        [ ! -f semgrep-results.json ] && echo "‚ùå Fichier non trouv√©" && exit 1
        
        echo "üìå Utilisation de l'engagement fixe #1 (pas besoin de jq pour √ßa)"
        ENGAGEMENT_ID=1
        
        echo "üì§ Import des r√©sultats Semgrep (Engagement #$ENGAGEMENT_ID)..."
        RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/import-scan/" \
          -H "Authorization: Token $DD_API_KEY" \
          -F "engagement=$ENGAGEMENT_ID" \
          -F "scan_type=Semgrep JSON Report" \
          -F "file=@semgrep-results.json" \
          -F "close_old_findings=true" \
          -F "minimum_severity=Info" \
          -F "environment=Development" \
          -F "branch_tag=${{ github.ref_name }}" \
          -F "commit_hash=${{ github.sha }}" \
          -F "build_id=${{ github.run_id }}")
        
        if echo "$RESPONSE" | grep -q "id"; then
          echo "‚úÖ Scan import√© avec succ√®s dans DefectDojo !"
        else
          echo "‚ö†Ô∏è  R√©ponse: $RESPONSE"
        fi

    - name: üéâ Pipeline termin√©
      run: echo "‚úÖ DevSecOps pipeline ex√©cut√© avec succ√®s sur runner self-hosted"