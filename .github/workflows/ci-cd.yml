name: ğŸš€ DevSecOps Full Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sast:
    name: ğŸ”’ SAST + DefectDojo
    runs-on: ubuntu-latest  # âš¡ CHANGEZ EN self-hosted POUR localhost
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©rer le code
      uses: actions/checkout@v4

    - name: ğŸ” Semgrep SAST
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: .semgrep.yml

    - name: ğŸ“¦ Installer Semgrep CLI
      run: pip install semgrep

    - name: ğŸ“Š GÃ©nÃ©rer rapport JSON
      run: semgrep --config .semgrep.yml --json --output semgrep-results.json
      continue-on-error: true

    - name: ğŸ“¤ Upload artefacts
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-results
        path: semgrep-results.json

    # ---------- ğŸš€ NOUVEAU : IMPORT DEFECTDOJO ----------
    - name: ğŸ“¤ Importer dans DefectDojo
      env:
        # âš ï¸ SI self-hosted : http://localhost:8080
        # âš ï¸ SI ubuntu-latest : http://192.168.11.170:8080 (IP de votre VM)
        DD_URL: http://192.168.11.170:8080  # Ã€ CHANGER selon votre config
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
        PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
      run: |
        echo "ğŸ” VÃ©rification du fichier JSON..."
        if [ ! -f semgrep-results.json ]; then
          echo "âŒ Fichier semgrep-results.json non trouvÃ© !"
          exit 1
        fi
        
        echo "ğŸ“Œ CrÃ©ation d'un engagement pour le commit ${{ github.sha }}..."
        TODAY=$(date +%Y-%m-%d)
        TOMORROW=$(date -d "+1 day" +%Y-%m-%d)
        
        ENGAGEMENT_RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/engagements/" \
          -H "Authorization: Token $DD_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "CI Scan - ${{ github.sha }}",
            "product": '"$PRODUCT_ID"',
            "target_start": "'"$TODAY"'",
            "target_end": "'"$TOMORROW"'",
            "status": "In Progress",
            "commit_hash": "${{ github.sha }}",
            "branch_tag": "${{ github.ref_name }}",
            "build_id": "${{ github.run_id }}",
            "build_server": "GitHub Actions"
          }')
        
        ENGAGEMENT_ID=$(echo "$ENGAGEMENT_RESPONSE" | jq -r '.id')
        echo "âœ… Engagement crÃ©Ã© avec ID: $ENGAGEMENT_ID"
        
        echo "ğŸ“¤ Import des rÃ©sultats Semgrep..."
        curl -X POST "$DD_URL/api/v2/import-scan/" \
          -H "Authorization: Token $DD_API_KEY" \
          -F "engagement=$ENGAGEMENT_ID" \
          -F "scan_type=Semgrep JSON Report" \
          -F "file=@semgrep-results.json" \
          -F "close_old_findings=true" \
          -F "minimum_severity=Info" \
          -F "environment=Development" \
          -F "branch_tag=${{ github.ref_name }}" \
          -F "commit_hash=${{ github.sha }}" \
          -F "build_id=${{ github.run_id }}"
        
        echo "âœ… Scan importÃ© avec succÃ¨s dans DefectDojo !"
        
        echo "ğŸ”’ Fermeture de l'engagement..."
        curl -s -X PATCH "$DD_URL/api/v2/engagements/$ENGAGEMENT_ID/" \
          -H "Authorization: Token $DD_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"status": "Completed"}' > /dev/null
        
        echo "ğŸ‰ Import terminÃ© avec succÃ¨s !"

    - name: ğŸ‰ Pipeline terminÃ©
      run: echo "âœ… DevSecOps pipeline completed successfully!"