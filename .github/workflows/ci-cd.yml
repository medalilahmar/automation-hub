name: ğŸ”’ SAST + DefectDojo (Self-Hosted)

on:
  push:
    branches: [ main ]

jobs:
  sast:
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ RÃ©cupÃ©rer le code
      uses: actions/checkout@v4

    - name: ğŸ” Semgrep SAST
      uses: returntocorp/semgrep-action@v1
      continue-on-error: true
      with:
        config: .semgrep.yml

    - name: ğŸ“¦ Installer Semgrep CLI
      run: |
        pip3 install --timeout 120 --retries 5 semgrep
        echo "$HOME/.local/bin" >> $GITHUB_PATH
      continue-on-error: true

    - name: ğŸ“¦ Installer jq
      run: |
        sudo apt install -y jq

    - name: ğŸ“Š GÃ©nÃ©rer rapport JSON
      run: semgrep --config .semgrep.yml --json --output semgrep-results.json

    - name: ğŸ“¤ Upload artefacts
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-results
        path: semgrep-results.json

    - name: ğŸ“¤ Importer dans DefectDojo
      env:
        DD_URL: http://localhost:8080
        DD_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
        PRODUCT_ID: ${{ secrets.PRODUCT_ID }}
      run: |
        echo "ğŸ” VÃ©rification du fichier JSON..."
        [ ! -f semgrep-results.json ] && exit 1
        
        echo "ğŸ“Œ CrÃ©ation d'un engagement..."
        TODAY=$(date +%Y-%m-%d)
        TOMORROW=$(date -d "+1 day" +%Y-%m-%d || date -v+1d +%Y-%m-%d)
        
        ENGAGEMENT_RESPONSE=$(curl -s -X POST "$DD_URL/api/v2/engagements/" \
          -H "Authorization: Token $DD_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "CI Scan - ${{ github.sha }}",
            "product": '"$PRODUCT_ID"',
            "target_start": "'"$TODAY"'",
            "target_end": "'"$TOMORROW"'",
            "status": "In Progress",
            "commit_hash": "${{ github.sha }}",
            "branch_tag": "${{ github.ref_name }}",
            "build_id": "${{ github.run_id }}",
            "build_server": "GitHub Actions Self-Hosted"
          }')
        
        ENGAGEMENT_ID=$(echo "$ENGAGEMENT_RESPONSE" | jq -r '.id // empty')
        
        if [ -z "$ENGAGEMENT_ID" ]; then
          echo "âŒ Erreur crÃ©ation engagement: $ENGAGEMENT_RESPONSE"
          exit 1
        fi
        
        echo "âœ… Engagement crÃ©Ã© avec ID: $ENGAGEMENT_ID"
        
        echo "ğŸ“¤ Import des rÃ©sultats Semgrep..."
        curl -s -X POST "$DD_URL/api/v2/import-scan/" \
          -H "Authorization: Token $DD_API_KEY" \
          -F "engagement=$ENGAGEMENT_ID" \
          -F "scan_type=Semgrep JSON Report" \
          -F "file=@semgrep-results.json" \
          -F "close_old_findings=true" \
          -F "minimum_severity=Info" \
          -F "environment=Development" \
          -F "branch_tag=${{ github.ref_name }}" \
          -F "commit_hash=${{ github.sha }}" \
          -F "build_id=${{ github.run_id }}"
        
        echo "âœ… Scan importÃ© avec succÃ¨s dans DefectDojo !"
        
        curl -s -X PATCH "$DD_URL/api/v2/engagements/$ENGAGEMENT_ID/" \
          -H "Authorization: Token $DD_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"status": "Completed"}' > /dev/null
        
        echo "ğŸ”’ Engagement fermÃ©."

    - name: ğŸ‰ Pipeline terminÃ©
      run: echo "âœ… DevSecOps pipeline completed successfully on self-hosted runner!"