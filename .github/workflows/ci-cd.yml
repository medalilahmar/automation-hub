name: ğŸš€ CI + SAST (Semgrep)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1 : Tests unitaires et intÃ©gration
  test:
    name: ğŸ§ª Tests API
    runs-on: ubuntu-latest   # âš¡ Remplacez par self-hosted si vous utilisez votre VM
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm ci

      - name: ğŸ” Linter ESLint
        run: npm run lint
        continue-on-error: true

      - name: ğŸ§ª ExÃ©cuter les tests unitaires
        run: npm test

      - name: ğŸ“Š GÃ©nÃ©rer le rapport de couverture
        run: npm run coverage
        continue-on-error: true

      - name: ğŸ“¤ Upload rapport de couverture
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # Job 2 : SAST avec Semgrep
  sast:
    name: ğŸ”’ SAST - Semgrep
    runs-on: ubuntu-latest   # âš¡ Remplacez par self-hosted si besoin
    needs: test             # DÃ©pend du job test
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4

      - name: ğŸ” Scan Semgrep
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        continue-on-error: true   # Ne bloque pas le pipeline
        with:
          config: .semgrep.yml
          json: true
          output: semgrep-results.json

      - name: ğŸ“Š Afficher le rÃ©sumÃ©
        run: |
          echo "=== RÃ‰SULTATS SAST ==="
          echo "ğŸ” Scan terminÃ©"
          echo "ğŸ“ Fichier de rÃ¨gles : .semgrep.yml"
          if [ -f semgrep-results.json ]; then
            COUNT=$(jq '.results | length' semgrep-results.json)
            echo "âš ï¸  $COUNT vulnÃ©rabilitÃ©(s) trouvÃ©e(s)"
          else
            echo "âœ… Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e"
          fi

      - name: ğŸ“¤ Upload des rÃ©sultats Semgrep
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json

  # Job 3 : Conclusion (optionnel)
  conclusion:
    name: ğŸ‰ Pipeline terminÃ©
    runs-on: ubuntu-latest
    needs: [test, sast]
    if: always()
    steps:
      - run: echo "âœ… CI + SAST exÃ©cutÃ© avec succÃ¨s !"